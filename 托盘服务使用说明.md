# 彩票分析系统 - 托盘服务使用说明

## 简介

这是一个**后台运行的彩票分析系统**，通过系统托盘图标管理，无需每次手动启动服务。

## 核心特性

✅ **后台静默运行** - 无窗口，不打扰
✅ **系统托盘管理** - 右下角小图标，方便控制
✅ **一键访问** - 随时打开浏览器访问
✅ **自动服务** - 自动启动前后端，无需手动配置
✅ **开机自启** - 可配置开机自动运行

---

## 快速开始

### 第一步：安装依赖

双击运行 `安装依赖.bat`

这会安装以下必需的 Python 包：
- `pystray` - 系统托盘图标
- `Pillow` - 图像处理
- `psutil` - 进程管理
- `requests` - HTTP 请求

### 第二步：启动服务

**方式一：双击启动（推荐）**
```
双击运行：启动托盘服务.bat
```

**方式二：VBS 静默启动**
```
双击运行：启动托盘服务.vbs
```

**方式三：命令行启动**
```bash
pythonw tray_app.py
```

### 第三步：使用系统

启动后：
1. 系统托盘（屏幕右下角）会出现一个**绿色彩票图标**（"彩"字）
2. 右键点击图标，显示菜单：
   - **打开网页** - 在浏览器中打开系统（默认操作，可双击）
   - **查看状态** - 显示前后端服务运行状态
   - **重启服务** - 重启前后端服务
   - **退出** - 关闭所有服务并退出

3. 也可以直接在浏览器中访问：
   - 前端页面：http://localhost:8080
   - 后端 API：http://localhost:8000

---

## 托盘图标说明

### 图标样式
- **绿色圆形** + 白色"彩"字
- 位于系统托盘区域（任务栏右下角，时钟旁边）

### 如果图标未显示
1. 点击任务栏右下角的 **^** 展开隐藏图标
2. 图标可能被隐藏在折叠区域
3. 可以将图标拖出到任务栏，方便访问

### 托盘菜单功能详解

#### 1. 打开网页
- 在默认浏览器中打开系统前端页面
- 快捷操作：**双击图标**也可打开

#### 2. 查看状态
- 显示一个通知，包含：
  - 后端服务状态（运行中/已停止）
  - 前端服务状态（运行中/已停止）
- 用于快速检查服务是否正常

#### 3. 重启服务
- 停止并重新启动前后端服务
- 适用场景：
  - 服务异常需要重启
  - 修改了配置文件
  - 服务无法访问

#### 4. 退出
- 关闭所有服务（前端+后端）
- 退出托盘程序
- **重要**：这会完全停止系统

---

## 服务架构

### 前端服务
- **端口**: 8080
- **作用**: 提供 Web 界面
- **技术**: Python http.server
- **目录**: `frontend/`

### 后端服务
- **端口**: 8000
- **作用**: 提供 API 接口和数据处理
- **技术**: FastAPI + uvicorn
- **目录**: `backend/`

### 托盘服务
- **作用**: 管理前后端服务，提供系统托盘界面
- **技术**: pystray + Python
- **文件**: `tray_app.py`, `service_manager.py`

---

## 开机自启动

详见：`开机自启动配置.md`

**最简单方法**：
1. 右键 `启动托盘服务.vbs` → 创建快捷方式
2. 按 `Win + R` → 输入 `shell:startup` → 回车
3. 将快捷方式复制到打开的文件夹
4. 重启电脑验证

---

## 日志文件

程序运行时会生成日志，方便排查问题：

### 托盘服务日志
- 位置：`logs/tray_app.log`
- 内容：托盘程序启动、服务管理等信息

### 服务管理日志
- 位置：同一日志文件
- 内容：前后端服务启动、停止、健康检查等

### 查看日志
```bash
# Windows 记事本
notepad logs\tray_app.log

# 或使用文件管理器直接打开
```

---

## 常见问题

### Q1: 双击启动脚本后没有反应？
**A**:
1. 检查是否已安装依赖：运行 `安装依赖.bat`
2. 查看日志文件：`logs/tray_app.log`
3. 尝试命令行启动查看错误：`python tray_app.py`

### Q2: 托盘图标没有出现？
**A**:
1. 点击任务栏右下角的 **^** 查看隐藏图标
2. 检查是否已有实例在运行（会提示）
3. 查看日志排查问题

### Q3: 点击"打开网页"后无法访问？
**A**:
1. 右键图标 → "查看状态" 检查服务
2. 如果服务未运行，点击"重启服务"
3. 手动访问 http://localhost:8080 测试
4. 检查端口是否被占用

### Q4: 如何完全关闭程序？
**A**:
- 方式一：右键托盘图标 → "退出"
- 方式二：任务管理器 → 结束 `pythonw.exe` 进程

### Q5: 修改了代码/配置后如何生效？
**A**:
1. 右键托盘图标 → "退出"
2. 重新运行 `启动托盘服务.bat`
3. 或直接点击"重启服务"（仅重启前后端，不重启托盘程序）

### Q6: 端口被占用怎么办？
**A**:
1. 查找占用进程：
   ```cmd
   netstat -ano | findstr "8000"
   netstat -ano | findstr "8080"
   ```
2. 结束占用进程：
   ```cmd
   taskkill /F /PID <进程ID>
   ```
3. 或修改配置文件 `config.json` 更改端口

### Q7: 如何卸载自启动？
**A**:
- 按 `Win + R` → `shell:startup`
- 删除相关快捷方式

---

## 技术细节

### 单实例检测
- 程序会自动检测是否已有实例在运行
- 如果已运行，会弹出提示，防止重复启动
- 使用 Socket 端口 58888 作为单实例锁

### 进程管理
- 使用 `psutil` 库管理进程
- 支持优雅关闭和强制结束
- 自动检测端口占用

### 健康检查
- 每次启动后检查服务是否正常响应
- 启动超时时间：
  - 后端：30 秒
  - 前端：15 秒

### 无窗口启动
- Windows：使用 `pythonw.exe` + `CREATE_NO_WINDOW` 标志
- 完全后台运行，无任何窗口

---

## 文件说明

| 文件名 | 说明 |
|--------|------|
| `tray_app.py` | 托盘主程序 |
| `service_manager.py` | 服务管理模块 |
| `启动托盘服务.bat` | 批处理启动脚本 |
| `启动托盘服务.vbs` | VBS 静默启动脚本 |
| `安装依赖.bat` | 依赖安装脚本 |
| `requirements_tray.txt` | 托盘服务依赖列表 |
| `开机自启动配置.md` | 自启动配置指南 |
| `托盘服务使用说明.md` | 本文档 |

---

## 系统要求

- **操作系统**: Windows 7/8/10/11
- **Python**: 3.7 或更高版本
- **依赖包**: 见 `requirements_tray.txt`
- **权限**: 普通用户权限即可

---

## 更新日志

### v1.0.0 (2025-10-19)
- ✨ 首次发布
- ✅ 系统托盘图标功能
- ✅ 自动服务管理
- ✅ 开机自启动支持
- ✅ 完整的日志系统

---

## 技术支持

遇到问题？

1. 查看日志：`logs/tray_app.log`
2. 检查依赖：运行 `安装依赖.bat`
3. 查阅本文档的"常见问题"部分

---

**享受无感的后台服务体验！** 🎉
