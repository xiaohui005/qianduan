<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>接口请求提交页面</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/crypto-js@4.1.1/crypto-js.min.js"></script>
    <style>
        body {
            background-color: #f8f9fa;
            padding: 20px;
        }
        .card {
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        .card-header {
            background-color: #0d6efd;
            color: white;
            font-weight: bold;
        }
        .form-section {
            margin-bottom: 15px;
        }
        .response-area {
            background-color: #f8f9fa;
            border-radius: 5px;
            padding: 15px;
            margin-top: 20px;
            white-space: pre-wrap;
            font-family: monospace;
            min-height: 100px;
        }
        .signature-info {
            background-color: #e9ecef;
            padding: 10px;
            border-radius: 5px;
            margin-top: 10px;
            font-size: 0.9em;
        }
        .url-input {
            font-family: monospace;
            font-size: 0.9em;
        }
        .loading {
            display: none;
            color: #0d6efd;
            font-weight: bold;
        }
        .success {
            color: #198754;
        }
        .error {
            color: #dc3545;
        }
        .iframe-container {
            margin-top: 20px;
            border: 1px solid #dee2e6;
            border-radius: 5px;
            padding: 10px;
            background-color: #fff;
        }
        .iframe-container h5 {
            margin-bottom: 10px;
            color: #0d6efd;
        }
        .response-iframe {
            width: 100%;
            height: 600px;
            border: 1px solid #dee2e6;
            border-radius: 3px;
            transform: scale(0.9);
            transform-origin: top left;
            width: 111.11%; /* 补偿缩放 */
            height: 666px; /* 手机屏幕高度 */
        }
        .iframe-controls {
            margin-bottom: 10px;
            display: flex;
            gap: 10px;
            align-items: center;
        }
        .mobile-frame {
            position: relative;
            width: 375px; /* 手机宽度 */
            height: 667px; /* 手机高度 */
            border: 12px solid #000;
            border-radius: 25px;
            margin: 0 auto;
            background: #000;
            box-shadow: 0 10px 25px rgba(0,0,0,0.3);
        }
        .mobile-frame::before {
            content: '';
            position: absolute;
            top: -5px;
            left: 50%;
            transform: translateX(-50%);
            width: 60px;
            height: 5px;
            background: #333;
            border-radius: 0 0 10px 10px;
            z-index: 10;
        }
        .mobile-frame::after {
            content: '';
            position: absolute;
            bottom: -5px;
            left: 50%;
            transform: translateX(-50%);
            width: 40px;
            height: 5px;
            background: #333;
            border-radius: 10px 10px 0 0;
        }
        .iframe-wrapper {
            width: 100%;
            height: 100%;
            overflow: hidden;
            border-radius: 15px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1 class="mb-4 text-center">接口请求提交页面</h1>
        
        <!-- 登录接口卡片 -->
        <div class="card">
            <div class="card-header">1. 登录接口</div>
            <div class="card-body">
                <div class="form-section">
                    <label for="loginUrl" class="form-label">请求地址 *</label>
                    <input type="url" class="form-control url-input" id="loginUrl" 
                           value="https://xxxx/api/external/login" required>
                </div>
                
                <div class="form-section">
                    <label for="optionId" class="form-label">渠道配置ID (optionId) *</label>
                    <input type="number" class="form-control" id="optionId" required>
                </div>
                
                <div class="form-section">
                    <label for="userId" class="form-label">用户ID (userId) *</label>
                    <input type="number" class="form-control" id="userId" required>
                </div>
                
                <div class="form-section">
                    <label for="device" class="form-label">设备类型 (device) *</label>
                    <select class="form-select" id="device">
                        <option value="0">PC</option>
                        <option value="1">ANDROID</option>
                        <option value="2">IOS</option>
                        <option value="3">UNKNOWN</option>
                        <option value="4">PWA</option>
                        <option value="5">APK</option>
                    </select>
                </div>
                
                <div class="form-section">
                    <label for="secretKeyLogin" class="form-label">密钥 (key)</label>
                    <input type="password" class="form-control" id="secretKeyLogin" placeholder="请输入签名密钥">
                </div>
                
                <div class="signature-info">
                    <strong>签名信息:</strong>
                    <div id="loginSignatureInfo">等待输入参数...</div>
                </div>
                
                <button type="button" class="btn btn-primary mt-3" onclick="submitLogin()" id="loginBtn">
                    提交登录请求
                </button>
                <div class="loading mt-2" id="loginLoading">请求中...</div>
            </div>
        </div>
        
        <!-- 彩金充值接口卡片 -->
        <div class="card">
            <div class="card-header">2. 彩金充值接口</div>
            <div class="card-body">
                <div class="form-section">
                    <label for="rechargeUrl" class="form-label">请求地址 *</label>
                    <input type="url" class="form-control url-input" id="rechargeUrl" 
                           value="https://xxxx/api/external/recharge" required>
                </div>
                
                <div class="form-section">
                    <label for="amount" class="form-label">充值金额 (amount) *</label>
                    <input type="number" step="0.01" class="form-control" id="amount" required>
                </div>
                
                <div class="form-section">
                    <label for="rechargeUserId" class="form-label">用户ID (userId) *</label>
                    <input type="number" class="form-control" id="rechargeUserId" required>
                </div>
                
                <div class="form-section">
                    <label for="secretKeyRecharge" class="form-label">密钥 (key)</label>
                    <input type="password" class="form-control" id="secretKeyRecharge" placeholder="请输入签名密钥">
                </div>
                
                <div class="signature-info">
                    <strong>签名信息:</strong>
                    <div id="rechargeSignatureInfo">等待输入参数...</div>
                </div>
                
                <button type="button" class="btn btn-primary mt-3" onclick="submitRecharge()" id="rechargeBtn">
                    提交充值请求
                </button>
                <div class="loading mt-2" id="rechargeLoading">请求中...</div>
            </div>
        </div>
        
        <!-- 响应结果区域 -->
        <div class="card">
            <div class="card-header">响应结果</div>
            <div class="card-body">
                <div id="responseResult" class="response-area">等待请求...</div>
            </div>
        </div>
        
        <!-- 新增的iframe小窗口 -->
        <div class="card">
            <div class="card-header">域名预览 - 手机版</div>
            <div class="card-body">
                <div class="iframe-container">
                    <div class="iframe-controls">
                        <button class="btn btn-sm btn-outline-primary" onclick="refreshIframe()">
                            <i class="bi bi-arrow-clockwise"></i> 刷新页面
                        </button>
                        <button class="btn btn-sm btn-outline-secondary" onclick="openInNewTab()">
                            <i class="bi bi-box-arrow-up-right"></i> 新窗口打开
                        </button>
                        <span class="ms-auto">
                            <small class="text-muted">当前加载的域名: </small>
                            <span id="currentDomain" class="badge bg-info">无</span>
                        </span>
                    </div>
                    
                    <div class="mobile-frame">
                        <div class="iframe-wrapper">
                            <iframe id="domainFrame" class="response-iframe" 
                                    src="about:blank"
                                    sandbox="allow-same-origin allow-scripts allow-forms allow-popups"
                                    allow="fullscreen">
                            </iframe>
                        </div>
                    </div>
                    
                    <div class="mt-3 text-center">
                        <small class="text-muted">模拟手机视图 (375×667)</small>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // 计算MD5签名
        function calculateMD5(str) {
            return CryptoJS.MD5(str).toString();
        }
        
        // 更新登录接口签名信息
        function updateLoginSignature() {
            const optionId = document.getElementById('optionId').value;
            const userId = document.getElementById('userId').value;
            const device = document.getElementById('device').value;
            const secretKey = document.getElementById('secretKeyLogin').value;
            
            if (!optionId || !userId || !device || !secretKey) {
                document.getElementById('loginSignatureInfo').textContent = '请填写所有必填参数和密钥';
                return;
            }
            
            // 构建签名字符串
            const signStr = `device=${device}&optionId=${optionId}&userId=${userId}&key=${secretKey}`;
            const signature = calculateMD5(signStr);
            
            document.getElementById('loginSignatureInfo').innerHTML = 
                `签名字符串: ${signStr}<br>签名结果: ${signature}`;
        }
        
        // 更新充值接口签名信息
        function updateRechargeSignature() {
            const amount = document.getElementById('amount').value;
            const userId = document.getElementById('rechargeUserId').value;
            const secretKey = document.getElementById('secretKeyRecharge').value;
            
            if (!amount || !userId || !secretKey) {
                document.getElementById('rechargeSignatureInfo').textContent = '请填写所有必填参数和密钥';
                return;
            }
            
            // 构建签名字符串
            const signStr = `amount=${amount}&userId=${userId}&key=${secretKey}`;
            const signature = calculateMD5(signStr);
            
            document.getElementById('rechargeSignatureInfo').innerHTML = 
                `签名字符串: ${signStr}<br>签名结果: ${signature}`;
        }
        
        // 显示加载状态
        function showLoading(buttonId, loadingId) {
            document.getElementById(buttonId).disabled = true;
            document.getElementById(loadingId).style.display = 'block';
        }
        
        // 隐藏加载状态
        function hideLoading(buttonId, loadingId) {
            document.getElementById(buttonId).disabled = false;
            document.getElementById(loadingId).style.display = 'none';
        }
        
        // 刷新iframe
        function refreshIframe() {
            const domainFrame = document.getElementById('domainFrame');
            const currentSrc = domainFrame.src;
            if (currentSrc && currentSrc !== 'about:blank') {
                domainFrame.src = currentSrc;
            }
        }
        
        // 在新窗口打开
        function openInNewTab() {
            const currentSrc = document.getElementById('domainFrame').src;
            if (currentSrc && currentSrc !== 'about:blank') {
                window.open(currentSrc, '_blank');
            } else {
                alert('没有可用的URL');
            }
        }
        
        // 设置手机版视图的meta标签
        function setMobileViewport(iframe) {
            try {
                const iframeDoc = iframe.contentDocument || iframe.contentWindow.document;
                let viewportMeta = iframeDoc.querySelector('meta[name="viewport"]');
                
                if (!viewportMeta) {
                    viewportMeta = iframeDoc.createElement('meta');
                    viewportMeta.name = 'viewport';
                    iframeDoc.head.appendChild(viewportMeta);
                }
                
                viewportMeta.content = 'width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no';
            } catch (e) {
                // 跨域限制，无法修改iframe内容
                console.log('无法设置iframe视口:', e.message);
            }
        }
        
        // 提取并加载域名到iframe
        function loadDomainToIframe(data) {
            const domainFrame = document.getElementById('domainFrame');
            const currentDomainSpan = document.getElementById('currentDomain');
            
            // 尝试从响应数据中提取域名
            let domain = null;
            
            if (data && data.data) {
                // 如果data是字符串，尝试从中提取URL
                if (typeof data.data === 'string') {
                    // 尝试匹配URL
                    const urlMatch = data.data.match(/(https?:\/\/[^\s'"<>]+)/);
                    if (urlMatch) {
                        domain = urlMatch[0];
                    } else {
                        // 如果不是完整URL，尝试作为域名处理
                        domain = data.data.startsWith('http') ? data.data : `https://${data.data}`;
                    }
                } 
                // 如果data是对象，查找包含域名的字段
                else if (typeof data.data === 'object') {
                    // 查找可能包含域名的字段
                    const possibleFields = ['url', 'domain', 'link', 'site', 'host', 'redirectUrl', 'loginUrl', 'targetUrl'];
                    for (const field of possibleFields) {
                        if (data.data[field] && typeof data.data[field] === 'string') {
                            const urlMatch = data.data[field].match(/(https?:\/\/[^\s'"<>]+)/);
                            if (urlMatch) {
                                domain = urlMatch[0];
                                break;
                            }
                        }
                    }
                    
                    // 如果没有找到特定字段，遍历所有字段寻找URL
                    if (!domain) {
                        for (const key in data.data) {
                            if (typeof data.data[key] === 'string') {
                                const urlMatch = data.data[key].match(/(https?:\/\/[^\s'"<>]+)/);
                                if (urlMatch) {
                                    domain = urlMatch[0];
                                    break;
                                }
                            }
                        }
                    }
                }
            }
            
            if (domain) {
                try {
                    // 确保URL是有效的
                    const url = new URL(domain);
                    domainFrame.src = url.href;
                    currentDomainSpan.textContent = url.hostname;
                    currentDomainSpan.className = 'badge bg-success';
                    
                    // 延迟设置视口，确保iframe加载完成
                    setTimeout(() => {
                        setMobileViewport(domainFrame);
                    }, 1000);
                    
                } catch (e) {
                    currentDomainSpan.textContent = `无效URL: ${domain}`;
                    currentDomainSpan.className = 'badge bg-danger';
                    domainFrame.src = 'about:blank';
                }
            } else {
                currentDomainSpan.textContent = '未找到有效域名';
                currentDomainSpan.className = 'badge bg-warning';
                domainFrame.src = 'about:blank';
            }
        }
        
        // 提交登录请求
        async function submitLogin() {
            const url = document.getElementById('loginUrl').value;
            const optionId = document.getElementById('optionId').value;
            const userId = document.getElementById('userId').value;
            const device = document.getElementById('device').value;
            const secretKey = document.getElementById('secretKeyLogin').value;
            
            // 验证必填字段
            if (!url) {
                alert('请输入请求地址');
                return;
            }
            if (!optionId || !userId || !device || !secretKey) {
                alert('请填写所有必填参数和密钥');
                return;
            }
            
            // 计算签名
            const signStr = `device=${device}&optionId=${optionId}&userId=${userId}&key=${secretKey}`;
            const signature = calculateMD5(signStr);
            
            // 构建请求数据
            const requestData = {
                optionId: parseInt(optionId),
                userId: parseInt(userId),
                device: parseInt(device),
                sign: signature
            };
            
            // 显示请求信息
            document.getElementById('responseResult').innerHTML = 
                `<span class="text-primary">请求信息:</span>\n` +
                `请求地址: POST ${url}\n` +
                `请求头: Content-Type: application/json\n` +
                `请求体: ${JSON.stringify(requestData, null, 2)}\n\n` +
                `<span class="text-primary">等待响应...</span>`;
            
            // 显示加载状态
            showLoading('loginBtn', 'loginLoading');
            
            try {
                // 发送实际的HTTP请求
                const response = await fetch(url, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(requestData)
                });
                
                const data = await response.json();
                
                // 显示响应结果
                const statusClass = response.ok ? 'success' : 'error';
                document.getElementById('responseResult').innerHTML = 
                    `<span class="text-primary">请求信息:</span>\n` +
                    `请求地址: POST ${url}\n` +
                    `请求头: Content-Type: application/json\n` +
                    `请求体: ${JSON.stringify(requestData, null, 2)}\n\n` +
                    `<span class="${statusClass}">响应结果 (状态码: ${response.status}):</span>\n` +
                    `${JSON.stringify(data, null, 2)}`;
                
                // 加载域名到iframe
                loadDomainToIframe(data);
                
            } catch (error) {
                document.getElementById('responseResult').innerHTML = 
                    `<span class="text-primary">请求信息:</span>\n` +
                    `请求地址: POST ${url}\n` +
                    `请求头: Content-Type: application/json\n` +
                    `请求体: ${JSON.stringify(requestData, null, 2)}\n\n` +
                    `<span class="error">请求失败:</span>\n${error.message}`;
                    
                // 重置iframe
                document.getElementById('domainFrame').src = 'about:blank';
                document.getElementById('currentDomain').textContent = '请求失败';
                document.getElementById('currentDomain').className = 'badge bg-danger';
            } finally {
                // 隐藏加载状态
                hideLoading('loginBtn', 'loginLoading');
            }
        }
        
        // 提交充值请求
        async function submitRecharge() {
            const url = document.getElementById('rechargeUrl').value;
            const amount = document.getElementById('amount').value;
            const userId = document.getElementById('rechargeUserId').value;
            const secretKey = document.getElementById('secretKeyRecharge').value;
            
            // 验证必填字段
            if (!url) {
                alert('请输入请求地址');
                return;
            }
            if (!amount || !userId || !secretKey) {
                alert('请填写所有必填参数和密钥');
                return;
            }
            
            // 计算签名
            const signStr = `amount=${amount}&userId=${userId}&key=${secretKey}`;
            const signature = calculateMD5(signStr);
            
            // 构建请求数据
            const requestData = {
                amount: parseFloat(amount),
                userId: parseInt(userId),
                sign: signature
            };
            
            // 显示请求信息
            document.getElementById('responseResult').innerHTML = 
                `<span class="text-primary">请求信息:</span>\n` +
                `请求地址: POST ${url}\n` +
                `请求头: Content-Type: application/json\n` +
                `请求体: ${JSON.stringify(requestData, null, 2)}\n\n` +
                `<span class="text-primary">等待响应...</span>`;
            
            // 显示加载状态
            showLoading('rechargeBtn', 'rechargeLoading');
            
            try {
                // 发送实际的HTTP请求
                const response = await fetch(url, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(requestData)
                });
                
                const data = await response.json();
                
                // 显示响应结果
                const statusClass = response.ok ? 'success' : 'error';
                document.getElementById('responseResult').innerHTML = 
                    `<span class="text-primary">请求信息:</span>\n` +
                    `请求地址: POST ${url}\n` +
                    `请求头: Content-Type: application/json\n` +
                    `请求体: ${JSON.stringify(requestData, null, 2)}\n\n` +
                    `<span class="${statusClass}">响应结果 (状态码: ${response.status}):</span>\n` +
                    `${JSON.stringify(data, null, 2)}`;
                
                // 加载域名到iframe
                loadDomainToIframe(data);
                
            } catch (error) {
                document.getElementById('responseResult').innerHTML = 
                    `<span class="text-primary">请求信息:</span>\n` +
                    `请求地址: POST ${url}\n` +
                    `请求头: Content-Type: application/json\n` +
                    `请求体: ${JSON.stringify(requestData, null, 2)}\n\n` +
                    `<span class="error">请求失败:</span>\n${error.message}`;
                    
                // 重置iframe
                document.getElementById('domainFrame').src = 'about:blank';
                document.getElementById('currentDomain').textContent = '请求失败';
                document.getElementById('currentDomain').className = 'badge bg-danger';
            } finally {
                // 隐藏加载状态
                hideLoading('rechargeBtn', 'rechargeLoading');
            }
        }
        
        // 添加输入事件监听器，实时更新签名信息
        document.getElementById('optionId').addEventListener('input', updateLoginSignature);
        document.getElementById('userId').addEventListener('input', updateLoginSignature);
        document.getElementById('device').addEventListener('change', updateLoginSignature);
        document.getElementById('secretKeyLogin').addEventListener('input', updateLoginSignature);
        
        document.getElementById('amount').addEventListener('input', updateRechargeSignature);
        document.getElementById('rechargeUserId').addEventListener('input', updateRechargeSignature);
        document.getElementById('secretKeyRecharge').addEventListener('input', updateRechargeSignature);
    </script>
</body>
</html>