# 定时采集功能说明

## 功能概述

彩票分析系统现已支持**自动定时采集**功能，可以在您指定的时间自动采集澳门/香港开奖结果，无需手动操作。

## 核心特性

✅ **灵活配置** - 在 `config.json` 中自定义采集时间
✅ **多时间点** - 支持每天多个时间点自动采集
✅ **多彩种支持** - 澳门、香港独立配置
✅ **自动重试** - 采集失败自动重试，并切换备用数据源
✅ **自动推荐** - 采集成功后自动生成推荐号码（期号以0或5结尾时）
✅ **日志记录** - 完整的采集日志，可查询和清空
✅ **API 管理** - 提供完整的 API 接口进行管理

## 快速开始

### 1. 安装依赖

首先安装新增的 APScheduler 依赖：

```bash
pip install APScheduler
```

或者重新安装所有依赖：

```bash
pip install -r backend/requirements.txt
```

### 2. 配置采集时间

编辑 `config.json` 文件，添加 `AUTO_COLLECT` 配置节：

```json
{
  "AUTO_COLLECT": {
    "enabled": true,
    "retry_times": 3,
    "retry_interval": 60,
    "schedules": [
      {
        "name": "澳门早班采集",
        "lottery_type": "am",
        "times": ["14:05", "15:05", "16:05", "17:05", "18:05"],
        "source": "default",
        "enabled": true
      },
      {
        "name": "澳门晚班采集",
        "lottery_type": "am",
        "times": ["19:05", "20:05", "21:35", "22:05", "22:35", "23:05"],
        "source": "default",
        "enabled": true
      },
      {
        "name": "香港开奖采集",
        "lottery_type": "hk",
        "times": ["21:30"],
        "source": "default",
        "enabled": true
      }
    ]
  }
}
```

### 3. 启动系统

正常启动系统即可，调度器会自动加载：

```bash
python launcher.py
```

启动日志会显示：
```
正在加载定时采集调度器...
已添加定时任务: 澳门早班采集 - 14:05 (am)
已添加定时任务: 澳门早班采集 - 15:05 (am)
...
定时采集调度器加载完成
```

## 配置说明

### 全局配置

| 配置项 | 说明 | 默认值 |
|-------|------|--------|
| `enabled` | 是否启用自动采集 | `false` |
| `retry_times` | 采集失败重试次数 | `3` |
| `retry_interval` | 重试间隔（秒） | `60` |
| `schedules` | 任务计划列表 | `[]` |

### 任务计划配置

| 配置项 | 说明 | 必填 | 示例 |
|-------|------|------|------|
| `name` | 任务名称 | 是 | `"澳门早班采集"` |
| `lottery_type` | 彩种类型 | 是 | `"am"` 或 `"hk"` |
| `times` | 采集时间列表（24小时制） | 是 | `["14:05", "15:05"]` |
| `source` | 数据源 | 否 | `"default"` 或 `"wenlongzhu"` |
| `enabled` | 是否启用此任务 | 否 | `true` |

### 时间格式

采用 24 小时制，格式为 `HH:MM`：
- ✅ 正确：`"14:05"`, `"21:30"`, `"00:05"`
- ❌ 错误：`"2:05"`, `"14:5"`, `"25:00"`

## API 接口

系统提供完整的 REST API 用于管理调度器。

### 1. 获取调度器状态

```http
GET /api/scheduler/status
```

**响应示例：**
```json
{
  "running": true,
  "job_count": 15,
  "timezone": "Asia/Shanghai",
  "jobs": [
    {
      "id": "collect_am_1405",
      "name": "澳门早班采集_14:05",
      "next_run": "2025-10-14 14:05:00"
    }
  ]
}
```

### 2. 启动/停止调度器

```http
POST /api/scheduler/start   # 启动
POST /api/scheduler/stop    # 停止
```

### 3. 获取采集日志

```http
GET /api/scheduler/logs?limit=50
```

**响应示例：**
```json
{
  "logs": [
    {
      "time": "2025-10-14 14:05:30",
      "lottery_type": "am",
      "status": "success",
      "message": "成功采集3条数据",
      "data_count": 3
    }
  ],
  "count": 1
}
```

### 4. 手动触发采集

```http
POST /api/scheduler/trigger?lottery_type=am&source=default
```

### 5. 重新加载配置

```http
POST /api/scheduler/reload
```

修改 `config.json` 后调用此接口重新加载配置。

### 6. 清空日志

```http
POST /api/scheduler/logs/clear
```

## 采集工作流程

1. **到达设定时间** → 调度器自动触发采集任务
2. **采集数据** → 从配置的数据源获取最新开奖数据
3. **失败重试** → 如果采集失败，自动重试（最多3次）
4. **备用源** → 主源失败后自动切换到备用数据源（文龙珠）
5. **保存数据** → 将采集到的数据保存到数据库
6. **自动推荐** → 如果采集到期号以0或5结尾的数据，自动生成推荐号码
7. **记录日志** → 记录采集结果（成功/失败/数据条数）

## 日志状态说明

| 状态 | 颜色 | 说明 |
|------|------|------|
| `success` | 绿色 | 采集成功 |
| `error` | 红色 | 采集失败 |
| `warning` | 黄色 | 采集无新数据或其他警告 |

## 常见问题

### Q1: 如何禁用自动采集？

**方法1：** 在 `config.json` 中设置 `"enabled": false`
**方法2：** 调用 API `/api/scheduler/stop`
**方法3：** 禁用特定任务：将任务的 `"enabled"` 设为 `false`

### Q2: 如何修改采集时间？

1. 编辑 `config.json` 中的 `times` 数组
2. 调用 `/api/scheduler/reload` 重新加载配置
3. 或者重启系统

### Q3: 为什么没有自动采集？

检查以下项：
1. ✅ `config.json` 中 `AUTO_COLLECT.enabled` 是否为 `true`
2. ✅ 任务的 `enabled` 是否为 `true`
3. ✅ 时间格式是否正确（`HH:MM`）
4. ✅ 查看控制台是否有错误日志
5. ✅ 调用 `/api/scheduler/status` 检查调度器状态

### Q4: 如何查看采集是否成功？

**方法1：** 查看控制台日志输出
**方法2：** 调用 `/api/scheduler/logs` 查看采集日志
**方法3：** 查看数据库中的数据是否更新

### Q5: 采集失败怎么办？

系统会自动：
1. 重试3次（可配置）
2. 切换到备用数据源
3. 记录详细的错误日志

您可以：
1. 查看日志了解失败原因
2. 检查网络连接
3. 验证数据源URL是否有效
4. 手动触发一次采集测试

### Q6: 时区问题

系统默认使用 **Asia/Shanghai** 时区（东八区），所有时间均为北京时间。

### Q7: 如何避免重复采集？

系统内置去重机制：
- 采集时会检查数据库中已有的最大期号
- 只采集比最大期号更新的数据
- 避免重复插入

## 配置示例

### 澳门彩票（每小时一次）

```json
{
  "name": "澳门每小时采集",
  "lottery_type": "am",
  "times": [
    "10:05", "11:05", "12:05", "13:05", "14:05", "15:05",
    "16:05", "17:05", "18:05", "19:05", "20:05", "21:35",
    "22:05", "22:35", "23:05", "23:35", "00:05", "00:35",
    "01:05"
  ],
  "source": "default",
  "enabled": true
}
```

### 香港彩票（每天一次）

```json
{
  "name": "香港每日采集",
  "lottery_type": "hk",
  "times": ["21:30"],
  "source": "default",
  "enabled": true
}
```

### 分时段配置（早中晚）

```json
{
  "schedules": [
    {
      "name": "澳门上午班",
      "lottery_type": "am",
      "times": ["10:05", "11:05", "12:05"],
      "source": "default",
      "enabled": true
    },
    {
      "name": "澳门下午班",
      "lottery_type": "am",
      "times": ["14:05", "15:05", "16:05", "17:05", "18:05"],
      "source": "default",
      "enabled": true
    },
    {
      "name": "澳门晚上班",
      "lottery_type": "am",
      "times": ["21:35", "22:05", "22:35", "23:05"],
      "source": "default",
      "enabled": true
    }
  ]
}
```

## 技术说明

### 调度器架构

- **库**: APScheduler 3.x
- **调度器类型**: BackgroundScheduler
- **触发器**: CronTrigger
- **时区**: Asia/Shanghai
- **线程安全**: 是

### 文件结构

```
backend/
├── scheduler.py          # 调度器模块（新增）
├── config.py             # 配置管理（已扩展）
├── main.py               # 主入口（已集成调度器）
└── routes/
    └── collect.py        # 采集路由（已添加调度器API）

frontend/
└── api.js                # API封装（已添加调度器API）
```

### 日志保留策略

- 最多保留 **100 条**日志
- 采用 **FIFO** 策略（先进先出）
- 可通过 API 清空日志

## 注意事项

1. **首次使用**需要安装 APScheduler 依赖
2. **修改配置后**需要重启系统或调用 reload API
3. **时间精度**为分钟级，秒数会被忽略
4. **系统时间**需要准确，建议启用时间同步
5. **日志文件**不会自动清理，需要定期维护
6. **跨零点任务**（如 `00:05`）会在次日凌晨执行

## 更新日志

### v1.0.0 (2025-10-14)
- ✨ 新增自动定时采集功能
- ✨ 支持灵活的时间配置
- ✨ 提供完整的 REST API
- ✨ 内置失败重试和备用源机制
- ✨ 自动推荐号码生成
- ✨ 采集日志记录和查询

## 技术支持

如有问题，请查看：
1. 控制台日志输出
2. 采集日志 API
3. config.json 配置文件
4. backend/scheduler.py 源码

---

**享受自动化采集的便利！** 🎉
