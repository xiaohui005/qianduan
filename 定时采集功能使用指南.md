# 定时采集功能使用指南

## 功能说明

彩票分析系统现已支持**自动定时采集**功能，每天自动采集一次澳门和香港的开奖结果，无需手动操作。

## 快速开始

### 1. 安装依赖

```bash
pip install APScheduler
```

### 2. 启动系统

```bash
python launcher.py
```

### 3. 配置采集时间

在前端页面左侧菜单中，找到并点击 **"定时采集设置"** 按钮（需要添加到菜单）。

## 页面配置说明

### 配置项

| 配置项 | 说明 | 默认值 |
|-------|------|--------|
| **启用自动采集** | 开关按钮，控制是否启用定时采集 | 关闭 |
| **澳门采集时间** | 每天采集澳门开奖的时间（24小时制） | 21:35 |
| **香港采集时间** | 每天采集香港开奖的时间（24小时制） | 21:30 |
| **数据源** | 选择默认源或备用源（文龙珠） | 默认源 |
| **失败重试次数** | 采集失败时的重试次数 | 3次 |

### 操作步骤

1. **设置时间**
   - 点击时间输入框
   - 选择小时和分钟
   - 建议设置在开奖后5-10分钟

2. **勾选启用**
   - 勾选"启用自动采集"开关
   - 配置才会生效

3. **保存配置**
   - 点击"保存配置"按钮
   - 系统会自动加载并启动定时任务
   - 提示"配置已保存并生效"即成功

4. **立即测试**
   - 点击"立即测试采集"按钮
   - 不等待定时，立即执行一次采集
   - 用于测试配置是否正常

## 查看运行状态

### 调度器状态

页面会显示：
- **运行状态**：运行中 / 已停止
- **任务数量**：当前已配置的定时任务数
- **时区**：系统时区（默认 Asia/Shanghai）
- **计划任务**：列表显示所有任务及下次执行时间

### 采集日志

实时显示最近50条采集记录：
- **时间**：采集执行时间
- **彩种**：澳门 / 香港
- **状态**：成功（绿色）/ 失败（红色）/ 警告（黄色）
- **消息**：采集详情
- **数据量**：采集到的数据条数

## 工作流程

```
1. 到达设定时间
   ↓
2. 自动触发采集
   ↓
3. 从数据源获取数据
   ↓
4. 失败？→ 重试3次
   ↓
5. 仍失败？→ 切换备用源
   ↓
6. 保存到数据库
   ↓
7. 期号0或5结尾？→ 自动生成推荐
   ↓
8. 记录日志
```

## 自动推荐说明

当采集到期号以 **0 或 5 结尾**的数据时，系统会自动：
- 生成推荐8码
- 生成推荐16码
- 在日志中显示"已自动生成推荐号码"

例如：
- 期号 2025**200** → 自动生成推荐
- 期号 2025**205** → 自动生成推荐
- 期号 2025201 → 不生成推荐

## 常见问题

### Q1: 如何知道定时任务已经设置成功？

查看"调度器状态"区域：
- 运行状态显示"● 运行中"（绿色）
- 任务数量显示 2 个（澳门+香港）
- 计划任务列表显示下次执行时间

### Q2: 设置了但没有自动采集？

检查以下几点：
1. ✅ 是否勾选了"启用自动采集"
2. ✅ 是否点击了"保存配置"按钮
3. ✅ 查看调度器状态是否为"运行中"
4. ✅ 确认系统时间是否准确
5. ✅ 查看采集日志中是否有错误信息

### Q3: 如何修改采集时间？

1. 在页面上修改时间
2. 点击"保存配置"
3. 系统会自动重新加载，新时间立即生效

### Q4: 采集失败怎么办？

系统会自动：
1. 重试3次（间隔一定时间）
2. 切换到备用数据源再次尝试
3. 记录详细的错误日志

您可以：
1. 查看采集日志了解失败原因
2. 尝试切换数据源
3. 使用"立即测试采集"手动触发

### Q5: 可以设置多个采集时间吗？

当前版本每个彩种**每天只能设置一次采集**。如果需要多次采集，请参考 `config.json` 手动配置（高级用户）。

### Q6: 如何临时禁用自动采集？

取消勾选"启用自动采集"，然后点击"保存配置"即可。

## 配置文件

如果您是高级用户，也可以直接编辑 `config.json`：

```json
{
  "AUTO_COLLECT": {
    "enabled": true,
    "retry_times": 3,
    "am_time": "21:35",
    "hk_time": "21:30",
    "source": "default"
  }
}
```

修改后需要重启系统或调用重新加载API。

## 技术说明

- **调度引擎**：APScheduler 3.x
- **时区**：Asia/Shanghai（北京时间）
- **精度**：分钟级
- **日志保留**：最近100条

## 推荐设置

### 澳门彩票
- **采集时间**：21:35 或 22:05
- 建议在晚上开奖高峰期后5-10分钟采集

### 香港彩票
- **采集时间**：21:30
- 香港每天开奖一次，建议在开奖后立即采集

## 注意事项

1. ⚠️ 系统时间必须准确，建议启用自动时间同步
2. ⚠️ 网络需要畅通，确保能访问数据源网站
3. ⚠️ 首次使用需要安装 APScheduler 依赖
4. ⚠️ 修改配置后需要点击"保存配置"才生效
5. ⚠️ 如果系统重启，定时任务会自动加载

## 故障排查

| 问题 | 可能原因 | 解决方法 |
|------|----------|----------|
| 未自动采集 | 未启用或未保存配置 | 检查开关状态，重新保存 |
| 采集失败 | 网络问题或数据源失效 | 查看日志，尝试切换数据源 |
| 状态显示异常 | 后端未启动或连接失败 | 检查后端服务，刷新页面 |
| 配置无法保存 | config.json 文件权限 | 检查文件权限，以管理员身份运行 |

## 技术支持

遇到问题请：
1. 查看控制台日志
2. 查看采集日志
3. 检查 `config.json` 配置
4. 访问 API 文档：http://localhost:8000/docs

---

**祝您使用愉快！** 🎉

每天定时自动采集，让您更省心！
