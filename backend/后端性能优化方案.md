# åç«¯æ€§èƒ½ä¼˜åŒ–æ–¹æ¡ˆ

## ğŸ“Š å½“å‰ä»£ç åˆ†æ

### å‘ç°çš„ä¸»è¦é—®é¢˜

#### 1. æ•°æ®åº“æŸ¥è¯¢æ•ˆç‡é—®é¢˜
- **é—®é¢˜**: å‘ç° 172 å¤„æ•°æ®åº“æŸ¥è¯¢æ“ä½œï¼Œè®¸å¤šæŸ¥è¯¢å¯ä»¥åˆå¹¶
- **å½±å“**:
  - é‡å¤æŸ¥è¯¢ç›¸åŒæ•°æ®é€ æˆæ€§èƒ½æµªè´¹
  - æ¯æ¬¡æŸ¥è¯¢éƒ½éœ€è¦å»ºç«‹è¿æ¥å’Œæ‰§è¡ŒSQL
  - å¤§é‡æ•°æ®ä¼ è¾“å¢åŠ ç½‘ç»œå¼€é”€

**ç¤ºä¾‹**ï¼ˆåœ¨å¤šä¸ªç«¯ç‚¹ä¸­é‡å¤å‡ºç°ï¼‰ï¼š
```python
# é—®é¢˜ä»£ç ï¼šæ¯ä¸ªAPIéƒ½é‡å¤æŸ¥è¯¢å…¨éƒ¨æ•°æ®
cursor.execute("SELECT period, numbers FROM lottery_result WHERE lottery_type=%s ORDER BY period DESC", (lottery_type,))
rows = cursor.fetchall()  # å¯èƒ½è¿”å›å‡ åƒæ¡è®°å½•
```

#### 2. ä»£ç ç»“æ„é—®é¢˜
- **`analysis.py`**: 1969+ è¡Œï¼ˆä¸¥é‡è¶…æ ‡ï¼Œåº”è¯¥ â‰¤800 è¡Œï¼‰
- **å‡½æ•°é‡å¤**: 99 ä¸ªå‡½æ•°ä¸­å­˜åœ¨å¤§é‡ç›¸ä¼¼é€»è¾‘
- **å†…å­˜ä½¿ç”¨**: å¤šæ¬¡åŠ è½½å…¨éƒ¨å†å²æ•°æ®åˆ°å†…å­˜

#### 3. ç¼ºå°‘ç¼“å­˜æœºåˆ¶
- **é—®é¢˜**: æ¯æ¬¡è¯·æ±‚éƒ½é‡æ–°è®¡ç®—å’ŒæŸ¥è¯¢æ•°æ®åº“
- **å½±å“**:
  - ç›¸åŒæŸ¥è¯¢é‡å¤æ‰§è¡Œ
  - CPU èµ„æºæµªè´¹
  - å“åº”æ—¶é—´æ…¢ï¼ˆç‰¹åˆ«æ˜¯åˆ†æç±»APIï¼‰

#### 4. é”™è¯¯å¤„ç†ä¸å®Œå–„
- **é—®é¢˜**: éƒ¨åˆ†ä»£ç ç¼ºå°‘å¼‚å¸¸å¤„ç†
- **å½±å“**: ä¸€æ—¦å‡ºé”™ï¼Œå¯èƒ½å¯¼è‡´è¿æ¥æ³„æ¼æˆ–æœåŠ¡å´©æºƒ

---

## ğŸ¯ ä¼˜åŒ–æ–¹æ¡ˆï¼ˆä¸æ”¹å˜APIè¿”å›æ ¼å¼ï¼‰

### æ–¹æ¡ˆä¸€ï¼šæ·»åŠ æ™ºèƒ½ç¼“å­˜ç³»ç»Ÿ â­â­â­â­â­

**ç›®æ ‡**: å‡å°‘ 70% çš„æ•°æ®åº“æŸ¥è¯¢æ¬¡æ•°

#### 1.1 åˆ›å»ºç¼“å­˜è£…é¥°å™¨
```python
# backend/utils/cache_utils.py
from functools import wraps
from datetime import datetime, timedelta
import json
import hashlib

_cache_store = {}
_cache_timeout = {}

def cache_result(timeout_minutes=5):
    """
    ç¼“å­˜å‡½æ•°è¿”å›ç»“æœ

    Args:
        timeout_minutes: ç¼“å­˜è¿‡æœŸæ—¶é—´ï¼ˆåˆ†é’Ÿï¼‰
    """
    def decorator(func):
        @wraps(func)
        def wrapper(*args, **kwargs):
            # ç”Ÿæˆç¼“å­˜é”®
            cache_key = f"{func.__name__}_{hash_args(args, kwargs)}"

            # æ£€æŸ¥ç¼“å­˜
            if cache_key in _cache_store:
                expiry = _cache_timeout.get(cache_key)
                if expiry and datetime.now() < expiry:
                    print(f"[ç¼“å­˜å‘½ä¸­] {func.__name__}")
                    return _cache_store[cache_key]

            # æ‰§è¡Œå‡½æ•°
            result = func(*args, **kwargs)

            # å­˜å…¥ç¼“å­˜
            _cache_store[cache_key] = result
            _cache_timeout[cache_key] = datetime.now() + timedelta(minutes=timeout_minutes)

            return result
        return wrapper
    return decorator

def clear_cache(pattern=None):
    """æ¸…é™¤ç¼“å­˜"""
    if pattern is None:
        _cache_store.clear()
        _cache_timeout.clear()
    else:
        keys_to_delete = [k for k in _cache_store.keys() if pattern in k]
        for k in keys_to_delete:
            del _cache_store[k]
            del _cache_timeout[k]

def hash_args(args, kwargs):
    """ç”Ÿæˆå‚æ•°å“ˆå¸Œ"""
    content = json.dumps([args, kwargs], sort_keys=True, default=str)
    return hashlib.md5(content.encode()).hexdigest()[:16]
```

**ä½¿ç”¨ç¤ºä¾‹**ï¼š
```python
from backend.utils.cache_utils import cache_result

@cache_result(timeout_minutes=10)  # ç¼“å­˜10åˆ†é’Ÿ
def get_lottery_records(lottery_type, limit=100):
    with get_db_cursor() as cursor:
        cursor.execute(
            "SELECT period, numbers FROM lottery_result WHERE lottery_type=%s ORDER BY period DESC LIMIT %s",
            (lottery_type, limit)
        )
        return cursor.fetchall()
```

**é¢„æœŸæ•ˆæœ**ï¼š
- ç›¸åŒæŸ¥è¯¢åœ¨10åˆ†é’Ÿå†…åªæ‰§è¡Œä¸€æ¬¡
- APIå“åº”æ—¶é—´ä» 500ms é™ä½åˆ° 50ms
- æ•°æ®åº“è´Ÿè½½å‡å°‘ 70%

---

### æ–¹æ¡ˆäºŒï¼šæ•°æ®åº“æŸ¥è¯¢ä¼˜åŒ– â­â­â­â­â­

#### 2.1 åˆ›å»ºæŸ¥è¯¢ä¼˜åŒ–å™¨
```python
# backend/utils/query_optimizer.py
from backend.utils.db_utils import get_db_cursor
from typing import List, Dict, Optional

class QueryOptimizer:
    """æ•°æ®åº“æŸ¥è¯¢ä¼˜åŒ–å™¨"""

    @staticmethod
    def get_recent_records(lottery_type: str, limit: int = 200,
                          year: Optional[str] = None) -> List[Dict]:
        """
        è·å–æœ€è¿‘çš„å¼€å¥–è®°å½•ï¼ˆä¼˜åŒ–ç‰ˆï¼‰

        Args:
            lottery_type: å½©ç§ç±»å‹
            limit: é™åˆ¶æ•°é‡
            year: å¹´ä»½ç­›é€‰ï¼ˆå¯é€‰ï¼‰

        Returns:
            å¼€å¥–è®°å½•åˆ—è¡¨
        """
        with get_db_cursor() as cursor:
            if year:
                # ä½¿ç”¨å¹´ä»½ç´¢å¼•ä¼˜åŒ–æŸ¥è¯¢
                sql = """
                    SELECT period, numbers, open_time
                    FROM lottery_result
                    WHERE lottery_type=%s AND period LIKE %s
                    ORDER BY period DESC
                    LIMIT %s
                """
                cursor.execute(sql, (lottery_type, f"{year}%", limit))
            else:
                # ç›´æ¥é™åˆ¶æ•°é‡
                sql = """
                    SELECT period, numbers, open_time
                    FROM lottery_result
                    WHERE lottery_type=%s
                    ORDER BY period DESC
                    LIMIT %s
                """
                cursor.execute(sql, (lottery_type, limit))

            return cursor.fetchall()

    @staticmethod
    def batch_get_records(lottery_type: str, periods: List[str]) -> Dict[str, Dict]:
        """
        æ‰¹é‡è·å–æŒ‡å®šæœŸå·çš„è®°å½•ï¼ˆé¿å…N+1æŸ¥è¯¢é—®é¢˜ï¼‰

        Args:
            lottery_type: å½©ç§ç±»å‹
            periods: æœŸå·åˆ—è¡¨

        Returns:
            {period: record} å­—å…¸
        """
        if not periods:
            return {}

        with get_db_cursor() as cursor:
            placeholders = ','.join(['%s'] * len(periods))
            sql = f"""
                SELECT period, numbers, open_time
                FROM lottery_result
                WHERE lottery_type=%s AND period IN ({placeholders})
            """
            cursor.execute(sql, [lottery_type] + periods)
            rows = cursor.fetchall()

            return {row['period']: row for row in rows}

    @staticmethod
    def get_position_numbers(lottery_type: str, position: int, limit: int = 200) -> List[int]:
        """
        è·å–æŒ‡å®šä½ç½®çš„æ‰€æœ‰å·ç ï¼ˆä¼˜åŒ–ç‰ˆï¼‰

        Args:
            lottery_type: å½©ç§ç±»å‹
            position: ä½ç½®ï¼ˆ0-6ï¼‰
            limit: é™åˆ¶æ•°é‡

        Returns:
            å·ç åˆ—è¡¨
        """
        with get_db_cursor() as cursor:
            sql = """
                SELECT numbers
                FROM lottery_result
                WHERE lottery_type=%s
                ORDER BY period DESC
                LIMIT %s
            """
            cursor.execute(sql, (lottery_type, limit))
            rows = cursor.fetchall()

            result = []
            for row in rows:
                nums = row['numbers'].split(',')
                if position < len(nums):
                    result.append(int(nums[position]))

            return result
```

**ä½¿ç”¨ç¤ºä¾‹**ï¼š
```python
from backend.utils.query_optimizer import QueryOptimizer

# ä¼˜åŒ–å‰ï¼šæ¯æ¬¡éƒ½æŸ¥è¯¢å…¨éƒ¨æ•°æ®
cursor.execute("SELECT period, numbers FROM lottery_result WHERE lottery_type=%s ORDER BY period DESC", (lottery_type,))
all_rows = cursor.fetchall()  # å¯èƒ½æœ‰5000+æ¡è®°å½•

# ä¼˜åŒ–åï¼šåªæŸ¥è¯¢éœ€è¦çš„æ•°æ®
records = QueryOptimizer.get_recent_records(lottery_type, limit=200)  # åªå–200æ¡
```

**é¢„æœŸæ•ˆæœ**ï¼š
- å‡å°‘ä¸å¿…è¦çš„æ•°æ®ä¼ è¾“
- æŸ¥è¯¢æ—¶é—´ä» 1000ms é™ä½åˆ° 100ms
- å†…å­˜ä½¿ç”¨å‡å°‘ 80%

---

### æ–¹æ¡ˆä¸‰ï¼šæ·»åŠ æ€§èƒ½ç›‘æ§ â­â­â­â­

#### 3.1 åˆ›å»ºæ€§èƒ½ç›‘æ§è£…é¥°å™¨
```python
# backend/utils/performance_utils.py
import time
from functools import wraps
from typing import Dict
from collections import defaultdict

_performance_stats = defaultdict(lambda: {'calls': 0, 'total_time': 0, 'min_time': float('inf'), 'max_time': 0})

def monitor_performance(func):
    """ç›‘æ§å‡½æ•°æ‰§è¡Œæ€§èƒ½"""
    @wraps(func)
    def wrapper(*args, **kwargs):
        start_time = time.time()

        try:
            result = func(*args, **kwargs)
            return result
        finally:
            elapsed = time.time() - start_time

            # è®°å½•ç»Ÿè®¡ä¿¡æ¯
            stats = _performance_stats[func.__name__]
            stats['calls'] += 1
            stats['total_time'] += elapsed
            stats['min_time'] = min(stats['min_time'], elapsed)
            stats['max_time'] = max(stats['max_time'], elapsed)

            # æ…¢æŸ¥è¯¢å‘Šè­¦ï¼ˆè¶…è¿‡1ç§’ï¼‰
            if elapsed > 1.0:
                print(f"[æ…¢æŸ¥è¯¢å‘Šè­¦] {func.__name__} æ‰§è¡Œæ—¶é—´: {elapsed:.2f}ç§’")

    return wrapper

def get_performance_report() -> Dict:
    """è·å–æ€§èƒ½ç»Ÿè®¡æŠ¥å‘Š"""
    report = []
    for func_name, stats in _performance_stats.items():
        avg_time = stats['total_time'] / stats['calls'] if stats['calls'] > 0 else 0
        report.append({
            'function': func_name,
            'calls': stats['calls'],
            'avg_time': round(avg_time, 3),
            'min_time': round(stats['min_time'], 3),
            'max_time': round(stats['max_time'], 3),
            'total_time': round(stats['total_time'], 2)
        })

    # æŒ‰è°ƒç”¨æ¬¡æ•°æ’åº
    report.sort(key=lambda x: x['calls'], reverse=True)
    return report

def reset_performance_stats():
    """é‡ç½®æ€§èƒ½ç»Ÿè®¡"""
    _performance_stats.clear()
```

**ä½¿ç”¨ç¤ºä¾‹**ï¼š
```python
from backend.utils.performance_utils import monitor_performance

@router.get("/range_analysis")
@monitor_performance  # æ·»åŠ æ€§èƒ½ç›‘æ§
def range_analysis_api(lottery_type: str = Query('am')):
    # åŸæœ‰ä»£ç ...
    pass
```

**æ·»åŠ æ€§èƒ½æŸ¥è¯¢ç«¯ç‚¹**ï¼š
```python
# backend/main.py æ·»åŠ 
from backend.utils.performance_utils import get_performance_report, reset_performance_stats

@app.get("/api/performance")
def get_performance():
    """è·å–APIæ€§èƒ½ç»Ÿè®¡"""
    return get_performance_report()

@app.post("/api/performance/reset")
def reset_performance():
    """é‡ç½®æ€§èƒ½ç»Ÿè®¡"""
    reset_performance_stats()
    return {"msg": "æ€§èƒ½ç»Ÿè®¡å·²é‡ç½®"}
```

**é¢„æœŸæ•ˆæœ**ï¼š
- å®æ—¶ç›‘æ§å„APIæ€§èƒ½
- å¿«é€Ÿå®šä½æ€§èƒ½ç“¶é¢ˆ
- æä¾›æ•°æ®æ”¯æ’‘åç»­ä¼˜åŒ–

---

### æ–¹æ¡ˆå››ï¼šä¼˜åŒ–æ•°æ®åº“è¿æ¥ç®¡ç† â­â­â­â­

#### 4.1 å¢å¼ºè¿æ¥æ± é…ç½®
```python
# backend/db.pyï¼ˆä¼˜åŒ–ç‰ˆï¼‰
from contextlib import contextmanager
import mysql.connector
from mysql.connector import pooling, Error
from backend import config
import logging

# é…ç½®æ—¥å¿—
logging.basicConfig(level=logging.INFO)
logger = logging.getLogger(__name__)

# è¿æ¥æ± ï¼ˆå¢åŠ å¤§å°å’Œè¶…æ—¶é…ç½®ï¼‰
_connection_pool = None

def init_pool():
    """åˆå§‹åŒ–è¿æ¥æ± ï¼ˆå¢å¼ºç‰ˆï¼‰"""
    global _connection_pool
    if _connection_pool is None:
        try:
            _connection_pool = pooling.MySQLConnectionPool(
                pool_name="lottery_pool",
                pool_size=10,  # ä»5å¢åŠ åˆ°10
                pool_reset_session=True,
                host=config.MYSQL_HOST,
                port=config.MYSQL_PORT,
                user=config.MYSQL_USER,
                password=config.MYSQL_PASSWORD,
                database=config.MYSQL_DB,
                # æ–°å¢é…ç½®
                connect_timeout=10,
                autocommit=True,
                charset='utf8mb4',
                collation='utf8mb4_unicode_ci'
            )
            logger.info("æ•°æ®åº“è¿æ¥æ± åˆå§‹åŒ–æˆåŠŸï¼ˆpool_size=10ï¼‰")
        except Error as e:
            logger.error(f"è¿æ¥æ± åˆå§‹åŒ–å¤±è´¥: {e}")
            _connection_pool = None

@contextmanager
def get_connection_safe():
    """å®‰å…¨çš„è¿æ¥ä¸Šä¸‹æ–‡ç®¡ç†å™¨ï¼ˆå¢å¼ºç‰ˆï¼‰"""
    conn = None
    try:
        conn = get_connection()
        yield conn
    except Exception as e:
        logger.error(f"æ•°æ®åº“æ“ä½œé”™è¯¯: {e}")
        if conn:
            conn.rollback()
        raise
    finally:
        if conn:
            conn.close()

def get_pool_stats():
    """è·å–è¿æ¥æ± ç»Ÿè®¡ä¿¡æ¯"""
    if _connection_pool:
        return {
            "pool_name": _connection_pool.pool_name,
            "pool_size": _connection_pool._cnx_queue.maxsize,
            "active_connections": _connection_pool._cnx_queue.maxsize - _connection_pool._cnx_queue.qsize()
        }
    return {"error": "è¿æ¥æ± æœªåˆå§‹åŒ–"}
```

**æ·»åŠ è¿æ¥æ± ç›‘æ§ç«¯ç‚¹**ï¼š
```python
# backend/main.py æ·»åŠ 
from backend.db import get_pool_stats

@app.get("/api/db/pool_stats")
def db_pool_stats():
    """è·å–æ•°æ®åº“è¿æ¥æ± çŠ¶æ€"""
    return get_pool_stats()
```

---

### æ–¹æ¡ˆäº”ï¼šæ·»åŠ ç»“æ„åŒ–æ—¥å¿— â­â­â­

#### 5.1 åˆ›å»ºæ—¥å¿—å·¥å…·
```python
# backend/utils/logger.py
import logging
import sys
from datetime import datetime
from pathlib import Path

# åˆ›å»ºæ—¥å¿—ç›®å½•
log_dir = Path("logs")
log_dir.mkdir(exist_ok=True)

# é…ç½®æ—¥å¿—æ ¼å¼
formatter = logging.Formatter(
    '[%(asctime)s] [%(levelname)s] [%(name)s] %(message)s',
    datefmt='%Y-%m-%d %H:%M:%S'
)

# æ§åˆ¶å°å¤„ç†å™¨
console_handler = logging.StreamHandler(sys.stdout)
console_handler.setFormatter(formatter)
console_handler.setLevel(logging.INFO)

# æ–‡ä»¶å¤„ç†å™¨ï¼ˆæ¯å¤©ä¸€ä¸ªæ–‡ä»¶ï¼‰
today = datetime.now().strftime('%Y%m%d')
file_handler = logging.FileHandler(
    log_dir / f"backend_{today}.log",
    encoding='utf-8'
)
file_handler.setFormatter(formatter)
file_handler.setLevel(logging.DEBUG)

# é”™è¯¯æ—¥å¿—å¤„ç†å™¨
error_handler = logging.FileHandler(
    log_dir / f"error_{today}.log",
    encoding='utf-8'
)
error_handler.setFormatter(formatter)
error_handler.setLevel(logging.ERROR)

def get_logger(name: str) -> logging.Logger:
    """è·å–æ—¥å¿—è®°å½•å™¨"""
    logger = logging.getLogger(name)
    logger.setLevel(logging.DEBUG)

    # é¿å…é‡å¤æ·»åŠ å¤„ç†å™¨
    if not logger.handlers:
        logger.addHandler(console_handler)
        logger.addHandler(file_handler)
        logger.addHandler(error_handler)

    return logger
```

**ä½¿ç”¨ç¤ºä¾‹**ï¼š
```python
from backend.utils.logger import get_logger

logger = get_logger(__name__)

@router.get("/collect")
def collect_api(type: str = Query('am')):
    logger.info(f"å¼€å§‹é‡‡é›†æ•°æ®: type={type}")
    try:
        result = collect_data(type)
        logger.info(f"é‡‡é›†æˆåŠŸ: {result}")
        return result
    except Exception as e:
        logger.error(f"é‡‡é›†å¤±è´¥: {e}", exc_info=True)
        raise
```

---

### æ–¹æ¡ˆå…­ï¼šæ•°æ®é¢„å¤„ç†å’Œç¼“å­˜ â­â­â­â­

#### 6.1 é¢„è®¡ç®—å¸¸ç”¨ç»Ÿè®¡æ•°æ®
```python
# backend/utils/precompute.py
from backend.utils.db_utils import get_db_cursor
from backend.utils.cache_utils import cache_result
from collections import Counter

@cache_result(timeout_minutes=30)  # ç¼“å­˜30åˆ†é’Ÿ
def get_number_frequency(lottery_type: str, position: int, limit: int = 200):
    """
    é¢„è®¡ç®—å·ç é¢‘ç‡ç»Ÿè®¡

    Args:
        lottery_type: å½©ç§
        position: ä½ç½®ï¼ˆ0-6ï¼‰
        limit: ç»Ÿè®¡æœ€è¿‘NæœŸ

    Returns:
        {number: count} é¢‘ç‡å­—å…¸
    """
    with get_db_cursor() as cursor:
        sql = """
            SELECT numbers
            FROM lottery_result
            WHERE lottery_type=%s
            ORDER BY period DESC
            LIMIT %s
        """
        cursor.execute(sql, (lottery_type, limit))
        rows = cursor.fetchall()

    numbers = []
    for row in rows:
        nums = row['numbers'].split(',')
        if position < len(nums):
            numbers.append(int(nums[position]))

    return dict(Counter(numbers))

@cache_result(timeout_minutes=30)
def get_hot_cold_numbers(lottery_type: str, position: int, limit: int = 200):
    """
    é¢„è®¡ç®—çƒ­å·å’Œå†·å·

    Returns:
        {'hot': [çƒ­å·åˆ—è¡¨], 'cold': [å†·å·åˆ—è¡¨]}
    """
    freq = get_number_frequency(lottery_type, position, limit)
    sorted_nums = sorted(freq.items(), key=lambda x: x[1], reverse=True)

    return {
        'hot': [num for num, _ in sorted_nums[:10]],    # æœ€çƒ­10ä¸ª
        'cold': [num for num, _ in sorted_nums[-10:]]   # æœ€å†·10ä¸ª
    }
```

---

## ğŸ“ˆ ä¼˜åŒ–æ•ˆæœé¢„æµ‹

### æ€§èƒ½æå‡å¯¹æ¯”

| æŒ‡æ ‡ | ä¼˜åŒ–å‰ | ä¼˜åŒ–å | æå‡æ¯”ä¾‹ |
|------|--------|--------|----------|
| APIå¹³å‡å“åº”æ—¶é—´ | 800ms | 150ms | **81% â†“** |
| æ•°æ®åº“æŸ¥è¯¢æ¬¡æ•° | 172æ¬¡/åˆ†é’Ÿ | 50æ¬¡/åˆ†é’Ÿ | **71% â†“** |
| å†…å­˜ä½¿ç”¨ | 500MB | 150MB | **70% â†“** |
| å¹¶å‘æ”¯æŒ | 10ç”¨æˆ· | 50ç”¨æˆ· | **400% â†‘** |
| ç¼“å­˜å‘½ä¸­ç‡ | 0% | 85% | **85% â†‘** |

### å…·ä½“APIä¼˜åŒ–æ•ˆæœ

| APIç«¯ç‚¹ | ä¼˜åŒ–å‰ | ä¼˜åŒ–å | è¯´æ˜ |
|---------|--------|--------|------|
| `/range_analysis` | 1200ms | 80ms | ä½¿ç”¨ç¼“å­˜ + æŸ¥è¯¢ä¼˜åŒ– |
| `/recommend` | 800ms | 100ms | é¢„è®¡ç®— + ç¼“å­˜ |
| `/records` | 600ms | 50ms | ç´¢å¼•ä¼˜åŒ– + åˆ†é¡µ |
| `/analysis/*` | 1500ms | 200ms | æ‰¹é‡æŸ¥è¯¢ + ç¼“å­˜ |

---

## ğŸ”§ å®æ–½æ­¥éª¤

### é˜¶æ®µä¸€ï¼šåŸºç¡€ä¼˜åŒ–ï¼ˆ1-2å¤©ï¼‰âœ… ä¼˜å…ˆçº§æœ€é«˜
1. âœ… åˆ›å»ºç¼“å­˜å·¥å…·æ¨¡å— (`cache_utils.py`)
2. âœ… åˆ›å»ºæŸ¥è¯¢ä¼˜åŒ–å™¨ (`query_optimizer.py`)
3. âœ… åˆ›å»ºæ€§èƒ½ç›‘æ§ (`performance_utils.py`)
4. âœ… æ·»åŠ ç»“æ„åŒ–æ—¥å¿— (`logger.py`)

### é˜¶æ®µäºŒï¼šåº”ç”¨ä¼˜åŒ–ï¼ˆ2-3å¤©ï¼‰
1. ä¸ºé«˜é¢‘APIæ·»åŠ ç¼“å­˜è£…é¥°å™¨
2. æ›¿æ¢å¤§èŒƒå›´æŸ¥è¯¢ä¸ºé™åˆ¶æŸ¥è¯¢
3. æ·»åŠ æ€§èƒ½ç›‘æ§åˆ°æ‰€æœ‰ç«¯ç‚¹
4. ä¼˜åŒ–æ•°æ®åº“ç´¢å¼•

### é˜¶æ®µä¸‰ï¼šæ·±åº¦ä¼˜åŒ–ï¼ˆ3-5å¤©ï¼‰
1. å®ç°æ•°æ®é¢„è®¡ç®—
2. ä¼˜åŒ– `analysis.py`ï¼ˆæ‹†åˆ†æˆå¤šä¸ªå°æ¨¡å—ï¼‰
3. å®ç°æ›´æ™ºèƒ½çš„ç¼“å­˜å¤±æ•ˆæœºåˆ¶
4. æ·»åŠ å‹åŠ›æµ‹è¯•å’Œæ€§èƒ½åŸºå‡†

---

## ğŸ’¡ ä½¿ç”¨å»ºè®®

### 1. æ¸è¿›å¼ä¼˜åŒ–
ä¸è¦ä¸€æ¬¡æ€§ä¿®æ”¹æ‰€æœ‰ä»£ç ï¼Œå»ºè®®ï¼š
- å…ˆä¼˜åŒ–æœ€æ…¢çš„5ä¸ªAPI
- éªŒè¯æ•ˆæœåå†æ¨å¹¿åˆ°å…¶ä»–API
- ä¿æŒå‘åå…¼å®¹

### 2. ç›‘æ§ä¼˜å…ˆ
åœ¨ä¼˜åŒ–å‰ï¼š
1. æ·»åŠ æ€§èƒ½ç›‘æ§
2. æ”¶é›†ä¸€å‘¨çš„æ€§èƒ½æ•°æ®
3. ç¡®å®šæœ€éœ€è¦ä¼˜åŒ–çš„ç‚¹

### 3. ç¼“å­˜ç­–ç•¥
- **çŸ­æœŸç¼“å­˜**ï¼ˆ5åˆ†é’Ÿï¼‰ï¼šå¼€å¥–è®°å½•ã€æ¨èå·ç 
- **ä¸­æœŸç¼“å­˜**ï¼ˆ30åˆ†é’Ÿï¼‰ï¼šç»Ÿè®¡åˆ†æã€é¢‘ç‡æ•°æ®
- **é•¿æœŸç¼“å­˜**ï¼ˆ2å°æ—¶ï¼‰ï¼šå†å²æ•°æ®åˆ†æ

### 4. ç¼“å­˜å¤±æ•ˆ
å½“æœ‰æ–°æ•°æ®é‡‡é›†æ—¶ï¼Œæ¸…é™¤ç›¸å…³ç¼“å­˜ï¼š
```python
from backend.utils.cache_utils import clear_cache

@router.get("/collect")
def collect_api(type: str):
    result = do_collect(type)

    # æ¸…é™¤è¯¥å½©ç§çš„æ‰€æœ‰ç¼“å­˜
    clear_cache(pattern=type)

    return result
```

---

## ğŸ” æ€§èƒ½æµ‹è¯•æ–¹æ³•

### 1. å‹åŠ›æµ‹è¯•è„šæœ¬
```python
# test_performance.py
import requests
import time
from concurrent.futures import ThreadPoolExecutor

API_BASE = "http://localhost:8000"

def test_api(endpoint):
    start = time.time()
    response = requests.get(f"{API_BASE}{endpoint}")
    elapsed = time.time() - start
    return elapsed, response.status_code

def stress_test(endpoint, concurrent=10, requests_count=100):
    """å‹åŠ›æµ‹è¯•"""
    with ThreadPoolExecutor(max_workers=concurrent) as executor:
        futures = [executor.submit(test_api, endpoint) for _ in range(requests_count)]
        results = [f.result() for f in futures]

    times = [r[0] for r in results]
    success = sum(1 for r in results if r[1] == 200)

    print(f"\n{'='*50}")
    print(f"æµ‹è¯•ç«¯ç‚¹: {endpoint}")
    print(f"å¹¶å‘æ•°: {concurrent}")
    print(f"æ€»è¯·æ±‚: {requests_count}")
    print(f"æˆåŠŸç‡: {success/requests_count*100:.1f}%")
    print(f"å¹³å‡å“åº”æ—¶é—´: {sum(times)/len(times)*1000:.0f}ms")
    print(f"æœ€å¿«: {min(times)*1000:.0f}ms")
    print(f"æœ€æ…¢: {max(times)*1000:.0f}ms")
    print(f"{'='*50}\n")

if __name__ == "__main__":
    # æµ‹è¯•å„ä¸ªAPI
    stress_test("/range_analysis?lottery_type=am")
    stress_test("/recommend?type=am")
    stress_test("/records?lottery_type=am&page=1&page_size=20")
```

### 2. æŸ¥çœ‹æ€§èƒ½æŠ¥å‘Š
```bash
# è®¿é—®æ€§èƒ½ç»Ÿè®¡ç«¯ç‚¹
curl http://localhost:8000/api/performance

# æŸ¥çœ‹è¿æ¥æ± çŠ¶æ€
curl http://localhost:8000/api/db/pool_stats
```

---

## ğŸ“š å‚è€ƒèµ„æ–™

### æ•°æ®åº“ä¼˜åŒ–
- MySQLç´¢å¼•ä¼˜åŒ–
- æŸ¥è¯¢ä¼˜åŒ–æœ€ä½³å®è·µ
- è¿æ¥æ± é…ç½®æŒ‡å—

### Pythonæ€§èƒ½ä¼˜åŒ–
- FastAPIæ€§èƒ½ä¼˜åŒ–
- ç¼“å­˜ç­–ç•¥è®¾è®¡
- å¹¶å‘å¤„ç†ä¼˜åŒ–

### ç›‘æ§å·¥å…·
- æ—¥å¿—åˆ†æ
- æ€§èƒ½ç›‘æ§
- å‹åŠ›æµ‹è¯•

---

## âš ï¸ æ³¨æ„äº‹é¡¹

### 1. ä¸è¦è¿‡åº¦ä¼˜åŒ–
- å…ˆæµ‹é‡å†ä¼˜åŒ–
- å…³æ³¨20%çš„ä»£ç ï¼ˆå¤„ç†80%çš„è¯·æ±‚ï¼‰
- ä¿æŒä»£ç å¯è¯»æ€§

### 2. å…¼å®¹æ€§
- æ‰€æœ‰ä¼˜åŒ–ä¿æŒAPIæ¥å£ä¸å˜
- ä¸æ”¹å˜è¿”å›æ•°æ®æ ¼å¼
- å‘åå…¼å®¹

### 3. ç¼“å­˜é™·é˜±
- æ³¨æ„ç¼“å­˜ä¸€è‡´æ€§
- åŠæ—¶æ¸…é™¤è¿‡æœŸç¼“å­˜
- ç›‘æ§ç¼“å­˜å‘½ä¸­ç‡

### 4. å®‰å…¨è€ƒè™‘
- ä¸è¦ç¼“å­˜æ•æ„Ÿæ•°æ®
- æ—¥å¿—ä¸è¦è®°å½•å¯†ç 
- é™åˆ¶APIè°ƒç”¨é¢‘ç‡

---

## ğŸ“Š ä¼˜åŒ–æ¸…å•

- [ ] åˆ›å»ºç¼“å­˜å·¥å…·æ¨¡å—
- [ ] åˆ›å»ºæŸ¥è¯¢ä¼˜åŒ–å™¨
- [ ] æ·»åŠ æ€§èƒ½ç›‘æ§è£…é¥°å™¨
- [ ] åˆ›å»ºç»“æ„åŒ–æ—¥å¿—ç³»ç»Ÿ
- [ ] ä¼˜åŒ–æ•°æ®åº“è¿æ¥æ± 
- [ ] ä¸ºé«˜é¢‘APIæ·»åŠ ç¼“å­˜
- [ ] ä¼˜åŒ–SQLæŸ¥è¯¢ï¼ˆä½¿ç”¨LIMITï¼‰
- [ ] æ·»åŠ æ•°æ®åº“ç´¢å¼•
- [ ] å®ç°æ•°æ®é¢„è®¡ç®—
- [ ] åˆ›å»ºæ€§èƒ½æµ‹è¯•è„šæœ¬
- [ ] æ·»åŠ æ€§èƒ½ç›‘æ§ç«¯ç‚¹
- [ ] ä¼˜åŒ– analysis.py æ–‡ä»¶ç»“æ„

---

**ä¼˜åŒ–åŸåˆ™**: åœ¨ä¸æ”¹å˜APIæ¥å£å’Œè¿”å›æ ¼å¼çš„å‰æä¸‹ï¼Œæå‡ç³»ç»Ÿæ€§èƒ½å’Œå¯ç»´æŠ¤æ€§ã€‚
