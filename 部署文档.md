# å½©ç¥¨åˆ†æç³»ç»Ÿ - LinuxæœåŠ¡å™¨éƒ¨ç½²æ–‡æ¡£

## ğŸ“‹ éƒ¨ç½²ç¯å¢ƒè¦æ±‚

### ç³»ç»Ÿè¦æ±‚
- **æ“ä½œç³»ç»Ÿ**: Ubuntu 20.04+ / CentOS 8+ / Debian 11+
- **Python**: 3.8 æˆ–æ›´é«˜ç‰ˆæœ¬
- **MySQL**: 5.7 æˆ–æ›´é«˜ç‰ˆæœ¬
- **å†…å­˜**: è‡³å°‘ 2GB RAM
- **ç¡¬ç›˜**: è‡³å°‘ 10GB å¯ç”¨ç©ºé—´
- **ç½‘ç»œ**: å…¬ç½‘IPæˆ–åŸŸå

### å¿…éœ€è½¯ä»¶
- Python 3.8+
- MySQL æ•°æ®åº“
- Nginx åå‘ä»£ç†
- Gitï¼ˆå¯é€‰ï¼‰

---

## ğŸš€ ç¬¬ä¸€æ­¥ï¼šç³»ç»Ÿå‡†å¤‡

### 1.1 æ›´æ–°ç³»ç»Ÿè½¯ä»¶åŒ…
```bash
# Ubuntu/Debian
sudo apt update && sudo apt upgrade -y

# CentOS/RHEL
sudo yum update -y
```

### 1.2 å®‰è£… Python 3
```bash
# Ubuntu/Debian
sudo apt install python3 python3-pip python3-venv -y

# CentOS/RHEL
sudo yum install python3 python3-pip -y

# éªŒè¯å®‰è£…
python3 --version  # åº”æ˜¾ç¤º Python 3.8+
```

### 1.3 å®‰è£… MySQL
```bash
# Ubuntu/Debian
sudo apt install mysql-server -y

# CentOS/RHEL
sudo yum install mysql-server -y
sudo systemctl start mysqld
sudo systemctl enable mysqld

# å®‰å…¨é…ç½®ï¼ˆè®¾ç½®rootå¯†ç ï¼‰
sudo mysql_secure_installation
```

### 1.4 å®‰è£… Nginx
```bash
# Ubuntu/Debian
sudo apt install nginx -y

# CentOS/RHEL
sudo yum install nginx -y

# å¯åŠ¨å¹¶è®¾ç½®å¼€æœºè‡ªå¯
sudo systemctl start nginx
sudo systemctl enable nginx
```

---

## ğŸ“¦ ç¬¬äºŒæ­¥ï¼šä¸Šä¼ é¡¹ç›®æ–‡ä»¶

### 2.1 åˆ›å»ºé¡¹ç›®ç›®å½•
```bash
sudo mkdir -p /var/www/lottery
cd /var/www/lottery
```

### 2.2 ä¸Šä¼ æ–‡ä»¶ï¼ˆé€‰æ‹©å…¶ä¸­ä¸€ç§æ–¹å¼ï¼‰

#### æ–¹å¼Aï¼šä½¿ç”¨ Gitï¼ˆæ¨èï¼‰
```bash
sudo git clone https://your-repo-url.git .
```

#### æ–¹å¼Bï¼šä½¿ç”¨ SCP ä¸Šä¼ 
```bash
# åœ¨æœ¬åœ°ç”µè„‘æ‰§è¡Œï¼ˆWindows PowerShellï¼‰
scp -r C:\Users\Administrator\Desktop\six666 user@your-server-ip:/tmp/

# åœ¨æœåŠ¡å™¨ä¸Šç§»åŠ¨æ–‡ä»¶
sudo mv /tmp/six666/* /var/www/lottery/
```

#### æ–¹å¼Cï¼šä½¿ç”¨ FTP/SFTP å·¥å…·
ä½¿ç”¨ FileZilla æˆ– WinSCP å°†æ•´ä¸ªé¡¹ç›®æ–‡ä»¶å¤¹ä¸Šä¼ åˆ° `/var/www/lottery/`

### 2.3 è®¾ç½®æ–‡ä»¶æƒé™
```bash
sudo chown -R www-data:www-data /var/www/lottery
sudo chmod -R 755 /var/www/lottery
```

---

## ğŸ—„ï¸ ç¬¬ä¸‰æ­¥ï¼šé…ç½®æ•°æ®åº“

### 3.1 ç™»å½• MySQL
```bash
sudo mysql -u root -p
```

### 3.2 åˆ›å»ºæ•°æ®åº“å’Œç”¨æˆ·
```sql
-- åˆ›å»ºæ•°æ®åº“
CREATE DATABASE zhenghe CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;

-- åˆ›å»ºä¸“ç”¨ç”¨æˆ·ï¼ˆè¯·ä¿®æ”¹å¯†ç ï¼‰
CREATE USER 'lottery_user'@'localhost' IDENTIFIED BY 'your_strong_password_here';

-- æˆæƒ
GRANT ALL PRIVILEGES ON zhenghe.* TO 'lottery_user'@'localhost';
FLUSH PRIVILEGES;

-- é€€å‡º
EXIT;
```

### 3.3 ä¿®æ”¹é¡¹ç›®é…ç½®æ–‡ä»¶
```bash
cd /var/www/lottery
sudo nano config.json
```

ä¿®æ”¹ä»¥ä¸‹å†…å®¹ï¼š
```json
{
  "MYSQL_HOST": "localhost",
  "MYSQL_PORT": 3306,
  "MYSQL_USER": "lottery_user",
  "MYSQL_PASSWORD": "your_strong_password_here",
  "MYSQL_DB": "zhenghe",
  "API_HOST": "0.0.0.0",
  "API_PORT": 8000,
  "backend_port": 8000,
  "frontend_port": 8080
}
```

ä¿å­˜å¹¶é€€å‡ºï¼š`Ctrl+X` â†’ `Y` â†’ `Enter`

### 3.4 åˆå§‹åŒ–æ•°æ®åº“è¡¨
```bash
cd /var/www/lottery
python3 backend/init_database.py
```

---

## ğŸ ç¬¬å››æ­¥ï¼šé…ç½® Python åç«¯

### 4.1 åˆ›å»ºè™šæ‹Ÿç¯å¢ƒ
```bash
cd /var/www/lottery
python3 -m venv venv
source venv/bin/activate
```

### 4.2 å®‰è£…ä¾èµ–
```bash
pip install --upgrade pip
pip install -r requirements.txt
pip install gunicorn  # ç”Ÿäº§çº§WSGIæœåŠ¡å™¨
```

### 4.3 æµ‹è¯•åç«¯è¿è¡Œ
```bash
# æ¿€æ´»è™šæ‹Ÿç¯å¢ƒï¼ˆå¦‚æœæœªæ¿€æ´»ï¼‰
source /var/www/lottery/venv/bin/activate

# æµ‹è¯•è¿è¡Œ
cd /var/www/lottery
python3 -m uvicorn backend.main:app --host 0.0.0.0 --port 8000

# å¦‚æœå¯åŠ¨æˆåŠŸï¼ŒæŒ‰ Ctrl+C åœæ­¢
```

### 4.4 åˆ›å»º systemd æœåŠ¡ï¼ˆå¼€æœºè‡ªå¯ï¼‰
```bash
sudo nano /etc/systemd/system/lottery-backend.service
```

ç²˜è´´ä»¥ä¸‹å†…å®¹ï¼š
```ini
[Unit]
Description=Lottery Analysis Backend Service
After=network.target mysql.service

[Service]
Type=exec
User=www-data
Group=www-data
WorkingDirectory=/var/www/lottery
Environment="PATH=/var/www/lottery/venv/bin"
ExecStart=/var/www/lottery/venv/bin/gunicorn backend.main:app \
    -w 4 \
    -k uvicorn.workers.UvicornWorker \
    --bind 127.0.0.1:8000 \
    --access-logfile /var/log/lottery/access.log \
    --error-logfile /var/log/lottery/error.log \
    --log-level info

Restart=always
RestartSec=5

[Install]
WantedBy=multi-user.target
```

### 4.5 åˆ›å»ºæ—¥å¿—ç›®å½•
```bash
sudo mkdir -p /var/log/lottery
sudo chown www-data:www-data /var/log/lottery
```

### 4.6 å¯åŠ¨åç«¯æœåŠ¡
```bash
# é‡æ–°åŠ è½½ systemd é…ç½®
sudo systemctl daemon-reload

# å¯åŠ¨æœåŠ¡
sudo systemctl start lottery-backend

# æŸ¥çœ‹çŠ¶æ€
sudo systemctl status lottery-backend

# è®¾ç½®å¼€æœºè‡ªå¯
sudo systemctl enable lottery-backend

# æŸ¥çœ‹æ—¥å¿—
sudo tail -f /var/log/lottery/error.log
```

---

## ğŸŒ ç¬¬äº”æ­¥ï¼šé…ç½® Nginx

### 5.1 ä¿®æ”¹å‰ç«¯é…ç½®
```bash
sudo nano /var/www/lottery/frontend/js/config.js
```

ä¿®æ”¹ä¸ºï¼š
```javascript
// ä½¿ç”¨ç›¸å¯¹è·¯å¾„ï¼ŒNginxä¼šè‡ªåŠ¨ä»£ç†
window.BACKEND_URL = "/api";
```

### 5.2 åˆ›å»º Nginx ç«™ç‚¹é…ç½®
```bash
sudo nano /etc/nginx/sites-available/lottery
```

ç²˜è´´ä»¥ä¸‹å†…å®¹ï¼ˆ**è¯·ä¿®æ”¹ your-domain.com ä¸ºä½ çš„å®é™…åŸŸåæˆ–IP**ï¼‰ï¼š
```nginx
server {
    listen 80;
    server_name your-domain.com;  # ä¿®æ”¹ä¸ºä½ çš„åŸŸåæˆ–IP

    # è®¿é—®æ—¥å¿—
    access_log /var/log/nginx/lottery_access.log;
    error_log /var/log/nginx/lottery_error.log;

    # å‰ç«¯é™æ€æ–‡ä»¶
    location / {
        root /var/www/lottery/frontend;
        index index.html;
        try_files $uri $uri/ /index.html;

        # ç¼“å­˜é™æ€èµ„æº
        location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg)$ {
            expires 7d;
            add_header Cache-Control "public, immutable";
        }
    }

    # åç«¯APIåå‘ä»£ç†
    location /api/ {
        rewrite ^/api/(.*) /$1 break;
        proxy_pass http://127.0.0.1:8000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        # è¶…æ—¶è®¾ç½®
        proxy_connect_timeout 60s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;
    }

    # APIæ–‡æ¡£
    location /docs {
        proxy_pass http://127.0.0.1:8000/docs;
        proxy_set_header Host $host;
    }

    location /openapi.json {
        proxy_pass http://127.0.0.1:8000/openapi.json;
        proxy_set_header Host $host;
    }
}
```

### 5.3 å¯ç”¨ç«™ç‚¹é…ç½®
```bash
# åˆ›å»ºè½¯é“¾æ¥
sudo ln -s /etc/nginx/sites-available/lottery /etc/nginx/sites-enabled/

# æµ‹è¯•é…ç½®
sudo nginx -t

# é‡å¯ Nginx
sudo systemctl restart nginx
```

---

## ğŸ”’ ç¬¬å…­æ­¥ï¼šé…ç½® HTTPSï¼ˆå¯é€‰ä½†æ¨èï¼‰

### 6.1 å®‰è£… Certbot
```bash
# Ubuntu/Debian
sudo apt install certbot python3-certbot-nginx -y

# CentOS/RHEL
sudo yum install certbot python3-certbot-nginx -y
```

### 6.2 è·å– SSL è¯ä¹¦
```bash
sudo certbot --nginx -d your-domain.com

# æŒ‰æç¤ºè¾“å…¥é‚®ç®±ï¼ŒåŒæ„æ¡æ¬¾
# Certbot ä¼šè‡ªåŠ¨ä¿®æ”¹ Nginx é…ç½®å¹¶å¯ç”¨ HTTPS
```

### 6.3 è‡ªåŠ¨ç»­æœŸ
```bash
# æµ‹è¯•è‡ªåŠ¨ç»­æœŸ
sudo certbot renew --dry-run

# è®¾ç½®è‡ªåŠ¨ç»­æœŸï¼ˆå·²è‡ªåŠ¨é…ç½®cronä»»åŠ¡ï¼‰
sudo systemctl status certbot.timer
```

---

## ğŸ”¥ ç¬¬ä¸ƒæ­¥ï¼šé…ç½®é˜²ç«å¢™

### 7.1 ä½¿ç”¨ UFWï¼ˆUbuntu/Debianï¼‰
```bash
# å¯ç”¨é˜²ç«å¢™
sudo ufw enable

# å…è®¸SSHï¼ˆé‡è¦ï¼ï¼‰
sudo ufw allow 22/tcp

# å…è®¸HTTPå’ŒHTTPS
sudo ufw allow 80/tcp
sudo ufw allow 443/tcp

# æŸ¥çœ‹çŠ¶æ€
sudo ufw status
```

### 7.2 ä½¿ç”¨ firewalldï¼ˆCentOS/RHELï¼‰
```bash
sudo firewall-cmd --permanent --add-service=http
sudo firewall-cmd --permanent --add-service=https
sudo firewall-cmd --permanent --add-service=ssh
sudo firewall-cmd --reload
```

---

## âœ… ç¬¬å…«æ­¥ï¼šéªŒè¯éƒ¨ç½²

### 8.1 æµ‹è¯•åç«¯API
```bash
curl http://localhost:8000/
# åº”è¿”å›: {"msg":"å½©ç¥¨åˆ†æç³»ç»Ÿåç«¯å·²å¯åŠ¨"}

curl http://your-domain.com/api/
# åº”è¿”å›ç›¸åŒå†…å®¹
```

### 8.2 æµ‹è¯•å‰ç«¯è®¿é—®
åœ¨æµè§ˆå™¨æ‰“å¼€ï¼š`http://your-domain.com`
- åº”æ˜¾ç¤ºå½©ç¥¨åˆ†æç³»ç»Ÿé¦–é¡µ
- æ£€æŸ¥æµè§ˆå™¨æ§åˆ¶å°æ˜¯å¦æœ‰é”™è¯¯

### 8.3 æµ‹è¯•æ•°æ®é‡‡é›†åŠŸèƒ½
1. ç™»å½•ç³»ç»Ÿ
2. ç‚¹å‡» "æ•°æ®é‡‡é›†" â†’ "æ‰‹åŠ¨é‡‡é›†"
3. æ£€æŸ¥æ˜¯å¦èƒ½æˆåŠŸé‡‡é›†æ•°æ®

---

## ğŸ› ï¸ å¸¸ç”¨è¿ç»´å‘½ä»¤

### åç«¯æœåŠ¡ç®¡ç†
```bash
# æŸ¥çœ‹æœåŠ¡çŠ¶æ€
sudo systemctl status lottery-backend

# å¯åŠ¨æœåŠ¡
sudo systemctl start lottery-backend

# åœæ­¢æœåŠ¡
sudo systemctl stop lottery-backend

# é‡å¯æœåŠ¡
sudo systemctl restart lottery-backend

# æŸ¥çœ‹æ—¥å¿—
sudo journalctl -u lottery-backend -f
sudo tail -f /var/log/lottery/error.log
```

### Nginx ç®¡ç†
```bash
# æµ‹è¯•é…ç½®
sudo nginx -t

# é‡å¯ Nginx
sudo systemctl restart nginx

# æŸ¥çœ‹æ—¥å¿—
sudo tail -f /var/log/nginx/lottery_error.log
```

### æ•°æ®åº“ç®¡ç†
```bash
# ç™»å½•æ•°æ®åº“
sudo mysql -u lottery_user -p zhenghe

# å¤‡ä»½æ•°æ®åº“
mysqldump -u lottery_user -p zhenghe > backup_$(date +%Y%m%d).sql

# æ¢å¤æ•°æ®åº“
mysql -u lottery_user -p zhenghe < backup_20250101.sql
```

---

## ğŸ”„ æ›´æ–°éƒ¨ç½²

### æ›´æ–°ä»£ç 
```bash
# SSH ç™»å½•æœåŠ¡å™¨
cd /var/www/lottery

# æ‹‰å–æœ€æ–°ä»£ç ï¼ˆGitæ–¹å¼ï¼‰
sudo git pull

# æˆ–ä¸Šä¼ æ–°æ–‡ä»¶ï¼ˆSCP/FTPï¼‰

# æ¿€æ´»è™šæ‹Ÿç¯å¢ƒ
source venv/bin/activate

# æ›´æ–°ä¾èµ–
pip install -r requirements.txt

# é‡å¯åç«¯æœåŠ¡
sudo systemctl restart lottery-backend

# æ¸…é™¤ Nginx ç¼“å­˜ï¼ˆå¯é€‰ï¼‰
sudo systemctl reload nginx
```

---

## ğŸ› æ•…éšœæ’æŸ¥

### é—®é¢˜1ï¼šåç«¯æœåŠ¡å¯åŠ¨å¤±è´¥
```bash
# æŸ¥çœ‹è¯¦ç»†é”™è¯¯
sudo journalctl -u lottery-backend -n 50

# æ£€æŸ¥ç«¯å£å ç”¨
sudo netstat -tuln | grep 8000

# æ‰‹åŠ¨è¿è¡Œæµ‹è¯•
cd /var/www/lottery
source venv/bin/activate
python3 -m uvicorn backend.main:app --host 0.0.0.0 --port 8000
```

### é—®é¢˜2ï¼šæ•°æ®åº“è¿æ¥å¤±è´¥
```bash
# æ£€æŸ¥MySQLè¿è¡ŒçŠ¶æ€
sudo systemctl status mysql

# æµ‹è¯•æ•°æ®åº“è¿æ¥
mysql -u lottery_user -p -h localhost zhenghe

# æ£€æŸ¥é…ç½®æ–‡ä»¶
cat /var/www/lottery/config.json
```

### é—®é¢˜3ï¼šå‰ç«¯æ— æ³•è®¿é—®åç«¯
```bash
# æ£€æŸ¥ Nginx é…ç½®
sudo nginx -t

# æŸ¥çœ‹ Nginx é”™è¯¯æ—¥å¿—
sudo tail -f /var/log/nginx/lottery_error.log

# æ£€æŸ¥åç«¯æ˜¯å¦è¿è¡Œ
curl http://127.0.0.1:8000/
```

### é—®é¢˜4ï¼šæƒé™é”™è¯¯
```bash
# é‡ç½®æ–‡ä»¶æƒé™
sudo chown -R www-data:www-data /var/www/lottery
sudo chmod -R 755 /var/www/lottery

# æ—¥å¿—ç›®å½•æƒé™
sudo chown -R www-data:www-data /var/log/lottery
```

---

## ğŸ“Š æ€§èƒ½ä¼˜åŒ–å»ºè®®

### 1. æ•°æ®åº“ä¼˜åŒ–
```sql
-- ä¸ºå¸¸ç”¨æŸ¥è¯¢æ·»åŠ ç´¢å¼•
USE zhenghe;
CREATE INDEX idx_period ON lottery_result(period);
CREATE INDEX idx_lottery_type ON lottery_result(lottery_type);
CREATE INDEX idx_open_time ON lottery_result(open_time);
```

### 2. Nginx ç¼“å­˜é…ç½®
```nginx
# åœ¨ http å—ä¸­æ·»åŠ 
proxy_cache_path /var/cache/nginx levels=1:2 keys_zone=api_cache:10m max_size=100m inactive=60m;

# åœ¨ location /api/ å—ä¸­æ·»åŠ 
proxy_cache api_cache;
proxy_cache_valid 200 5m;
```

### 3. å¢åŠ  Gunicorn Worker æ•°é‡
```bash
# ç¼–è¾‘æœåŠ¡æ–‡ä»¶
sudo nano /etc/systemd/system/lottery-backend.service

# ä¿®æ”¹ -w å‚æ•°ï¼ˆworkeræ•°é‡ = CPUæ ¸å¿ƒæ•° * 2 + 1ï¼‰
ExecStart=/var/www/lottery/venv/bin/gunicorn backend.main:app \
    -w 8 \
    -k uvicorn.workers.UvicornWorker \
    --bind 127.0.0.1:8000

# é‡å¯æœåŠ¡
sudo systemctl daemon-reload
sudo systemctl restart lottery-backend
```

---

## ğŸ“ æŠ€æœ¯æ”¯æŒ

å¦‚é‡åˆ°éƒ¨ç½²é—®é¢˜ï¼Œè¯·æä¾›ä»¥ä¸‹ä¿¡æ¯ï¼š
1. æœåŠ¡å™¨ç³»ç»Ÿç‰ˆæœ¬ï¼š`cat /etc/os-release`
2. Pythonç‰ˆæœ¬ï¼š`python3 --version`
3. é”™è¯¯æ—¥å¿—ï¼š`sudo journalctl -u lottery-backend -n 100`
4. Nginxæ—¥å¿—ï¼š`sudo tail -100 /var/log/nginx/lottery_error.log`

---

## ğŸ“ éƒ¨ç½²æ£€æŸ¥æ¸…å•

- [ ] ç³»ç»Ÿè½¯ä»¶æ›´æ–°å®Œæˆ
- [ ] Python 3.8+ å·²å®‰è£…
- [ ] MySQL æ•°æ®åº“å·²å®‰è£…å¹¶é…ç½®
- [ ] Nginx å·²å®‰è£…
- [ ] é¡¹ç›®æ–‡ä»¶å·²ä¸Šä¼ åˆ° `/var/www/lottery`
- [ ] æ•°æ®åº“å·²åˆ›å»ºå¹¶åˆå§‹åŒ–
- [ ] `config.json` å·²æ­£ç¡®é…ç½®
- [ ] Pythonè™šæ‹Ÿç¯å¢ƒå·²åˆ›å»º
- [ ] ä¾èµ–åŒ…å·²å®‰è£…
- [ ] systemd æœåŠ¡å·²åˆ›å»ºå¹¶å¯åŠ¨
- [ ] Nginx é…ç½®å·²å®Œæˆ
- [ ] é˜²ç«å¢™è§„åˆ™å·²é…ç½®
- [ ] HTTPS è¯ä¹¦å·²é…ç½®ï¼ˆå¯é€‰ï¼‰
- [ ] å‰åç«¯è¿æ¥æµ‹è¯•é€šè¿‡
- [ ] æ•°æ®é‡‡é›†åŠŸèƒ½æµ‹è¯•é€šè¿‡

---

**éƒ¨ç½²å®Œæˆï¼è®¿é—® http://your-domain.com å¼€å§‹ä½¿ç”¨ç³»ç»Ÿã€‚**
